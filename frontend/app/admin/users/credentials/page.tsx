'use client';\n\nimport { useState, useEffect } from 'react';\nimport { Button } from '@/components/ui/Button';\nimport { Input } from '@/components/Input';\nimport { Table } from '@/components/Table';\nimport { useAuthStore } from '@/store/useAuthStore';\nimport { User, Key, Users, UserPlus, Edit3, Eye, EyeOff } from 'lucide-react';\n\ninterface StudentAccount {\n    id: string;\n    email: string;\n    name: string;\n    createdAt: string;\n    student: {\n        id: string;\n        name: string;\n        surname: string;\n        phone: string;\n    };\n}\n\ninterface ParentAccount {\n    id: string;\n    email: string;\n    name: string;\n    createdAt: string;\n    student: {\n        id: string;\n        name: string;\n        surname: string;\n        phone: string;\n    };\n}\n\ninterface TeacherAccount {\n    id: string;\n    email: string;\n    name: string;\n    createdAt: string;\n    groups: Array<{\n        id: string;\n        name: string;\n        subject: string;\n    }>;\n}\n\ninterface UserAccounts {\n    students: StudentAccount[];\n    parents: ParentAccount[];\n    teachers: TeacherAccount[];\n}\n\nexport default function UserCredentialsPage() {\n    const { accessToken } = useAuthStore();\n    const [accounts, setAccounts] = useState<UserAccounts | null>(null);\n    const [loading, setLoading] = useState(true);\n    const [activeTab, setActiveTab] = useState<'students' | 'parents' | 'teachers'>('students');\n    \n    // Student creation\n    const [showStudentForm, setShowStudentForm] = useState(false);\n    const [selectedStudentId, setSelectedStudentId] = useState('');\n    const [availableStudents, setAvailableStudents] = useState<any[]>([]);\n    \n    // Parent creation\n    const [showParentForm, setShowParentForm] = useState(false);\n    const [selectedParentStudentId, setSelectedParentStudentId] = useState('');\n    \n    // Teacher creation/edit\n    const [showTeacherForm, setShowTeacherForm] = useState(false);\n    const [editingTeacher, setEditingTeacher] = useState<TeacherAccount | null>(null);\n    const [teacherForm, setTeacherForm] = useState({\n        name: '',\n        email: '',\n        phone: '',\n        password: '',\n        groupIds: [] as string[]\n    });\n    \n    const [availableGroups, setAvailableGroups] = useState<any[]>([]);\n    const [showPassword, setShowPassword] = useState(false);\n    const [credentialsResult, setCredentialsResult] = useState<any>(null);\n\n    useEffect(() => {\n        fetchUserAccounts();\n        fetchAvailableStudents();\n        fetchAvailableGroups();\n    }, []);\n\n    const fetchUserAccounts = async () => {\n        try {\n            const response = await fetch('/api/users/accounts', {\n                headers: {\n                    'Authorization': `Bearer ${accessToken}`,\n                },\n            });\n\n            if (response.ok) {\n                const data = await response.json();\n                setAccounts(data.data);\n            }\n        } catch (error) {\n            console.error('Error fetching user accounts:', error);\n        } finally {\n            setLoading(false);\n        }\n    };\n\n    const fetchAvailableStudents = async () => {\n        try {\n            const response = await fetch('/api/students', {\n                headers: {\n                    'Authorization': `Bearer ${accessToken}`,\n                },\n            });\n\n            if (response.ok) {\n                const data = await response.json();\n                setAvailableStudents(data.data || []);\n            }\n        } catch (error) {\n            console.error('Error fetching students:', error);\n        }\n    };\n\n    const fetchAvailableGroups = async () => {\n        try {\n            const response = await fetch('/api/groups', {\n                headers: {\n                    'Authorization': `Bearer ${accessToken}`,\n                },\n            });\n\n            if (response.ok) {\n                const data = await response.json();\n                setAvailableGroups(data.data || []);\n            }\n        } catch (error) {\n            console.error('Error fetching groups:', error);\n        }\n    };\n\n    const createStudentCredentials = async () => {\n        try {\n            const response = await fetch('/api/users/credentials/student', {\n                method: 'POST',\n                headers: {\n                    'Authorization': `Bearer ${accessToken}`,\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify({ studentId: selectedStudentId }),\n            });\n\n            if (response.ok) {\n                const result = await response.json();\n                setCredentialsResult(result.data);\n                setShowStudentForm(false);\n                setSelectedStudentId('');\n                fetchUserAccounts();\n                alert(`Identifiants créés! Email: ${result.data.credentials.email}, Mot de passe: ${result.data.credentials.password}`);\n            }\n        } catch (error) {\n            console.error('Error creating student credentials:', error);\n            alert('Erreur lors de la création des identifiants étudiant');\n        }\n    };\n\n    const createParentCredentials = async () => {\n        try {\n            const response = await fetch('/api/users/credentials/parent', {\n                method: 'POST',\n                headers: {\n                    'Authorization': `Bearer ${accessToken}`,\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify({ studentId: selectedParentStudentId }),\n            });\n\n            if (response.ok) {\n                const result = await response.json();\n                setCredentialsResult(result.data);\n                setShowParentForm(false);\n                setSelectedParentStudentId('');\n                fetchUserAccounts();\n                alert(`Identifiants parent créés! Email: ${result.data.credentials.email}, Mot de passe: ${result.data.credentials.password}`);\n            }\n        } catch (error) {\n            console.error('Error creating parent credentials:', error);\n            alert('Erreur lors de la création des identifiants parent');\n        }\n    };\n\n    const createOrUpdateTeacherCredentials = async () => {\n        try {\n            const url = editingTeacher \n                ? `/api/users/credentials/teacher/${editingTeacher.id}`\n                : '/api/users/credentials/teacher';\n            \n            const method = editingTeacher ? 'PUT' : 'POST';\n            \n            const response = await fetch(url, {\n                method,\n                headers: {\n                    'Authorization': `Bearer ${accessToken}`,\n                    'Content-Type': 'application/json',\n                },\n                body: JSON.stringify(teacherForm),\n            });\n\n            if (response.ok) {\n                const result = await response.json();\n                setCredentialsResult(result.data);\n                setShowTeacherForm(false);\n                setEditingTeacher(null);\n                setTeacherForm({ name: '', email: '', phone: '', password: '', groupIds: [] });\n                fetchUserAccounts();\n                \n                if (!editingTeacher) {\n                    alert(`Identifiants enseignant créés! Email: ${result.data.credentials.email}, Mot de passe: ${result.data.credentials.password}`);\n                } else {\n                    alert('Identifiants enseignant mis à jour avec succès!');\n                }\n            }\n        } catch (error) {\n            console.error('Error saving teacher credentials:', error);\n            alert('Erreur lors de la sauvegarde des identifiants enseignant');\n        }\n    };\n\n    const openTeacherEdit = (teacher: TeacherAccount) => {\n        setEditingTeacher(teacher);\n        setTeacherForm({\n            name: teacher.name,\n            email: teacher.email,\n            phone: '',\n            password: '',\n            groupIds: teacher.groups.map(g => g.id)\n        });\n        setShowTeacherForm(true);\n    };\n\n    if (loading) {\n        return (\n            <div className=\"flex items-center justify-center min-h-64\">\n                <div className=\"animate-spin rounded-full h-32 w-32 border-b-2 border-blue-500\"></div>\n            </div>\n        );\n    }\n\n    const studentColumns = [\n        { key: 'name', label: 'Nom' },\n        { key: 'email', label: 'Email' },\n        { key: 'student', label: 'Étudiant', render: (account: StudentAccount) => `${account.student.name} ${account.student.surname}` },\n        { key: 'createdAt', label: 'Créé le', render: (account: StudentAccount) => new Date(account.createdAt).toLocaleDateString('fr-FR') }\n    ];\n\n    const parentColumns = [\n        { key: 'name', label: 'Nom' },\n        { key: 'email', label: 'Email' },\n        { key: 'student', label: 'Enfant', render: (account: ParentAccount) => `${account.student.name} ${account.student.surname}` },\n        { key: 'createdAt', label: 'Créé le', render: (account: ParentAccount) => new Date(account.createdAt).toLocaleDateString('fr-FR') }\n    ];\n\n    const teacherColumns = [\n        { key: 'name', label: 'Nom' },\n        { key: 'email', label: 'Email' },\n        { key: 'groups', label: 'Groupes', render: (account: TeacherAccount) => account.groups.map(g => g.name).join(', ') },\n        { \n            key: 'actions', \n            label: 'Actions', \n            render: (account: TeacherAccount) => (\n                <Button\n                    onClick={() => openTeacherEdit(account)}\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    className=\"text-blue-600 hover:text-blue-700\"\n                >\n                    <Edit3 className=\"w-4 h-4\" />\n                    Modifier\n                </Button>\n            )\n        }\n    ];\n\n    return (\n        <div className=\"space-y-6\">\n            {/* Header */}\n            <div className=\"bg-white rounded-lg shadow p-6\">\n                <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center space-x-3\">\n                        <Key className=\"h-8 w-8 text-blue-600\" />\n                        <div>\n                            <h1 className=\"text-2xl font-bold text-gray-900\">Gestion des Identifiants</h1>\n                            <p className=\"text-gray-600\">Créez et gérez les identifiants pour les étudiants, parents et enseignants</p>\n                        </div>\n                    </div>\n                </div>\n            </div>\n\n            {/* Tabs */}\n            <div className=\"bg-white rounded-lg shadow\">\n                <div className=\"border-b border-gray-200\">\n                    <nav className=\"flex space-x-8 px-6\">\n                        {[\n                            { key: 'students', label: 'Étudiants', count: accounts?.students.length || 0 },\n                            { key: 'parents', label: 'Parents', count: accounts?.parents.length || 0 },\n                            { key: 'teachers', label: 'Enseignants', count: accounts?.teachers.length || 0 }\n                        ].map((tab) => (\n                            <button\n                                key={tab.key}\n                                onClick={() => setActiveTab(tab.key as any)}\n                                className={`py-4 px-1 border-b-2 font-medium text-sm ${\n                                    activeTab === tab.key\n                                        ? 'border-blue-500 text-blue-600'\n                                        : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'\n                                }`}\n                            >\n                                {tab.label} ({tab.count})\n                            </button>\n                        ))}\n                    </nav>\n                </div>\n\n                <div className=\"p-6\">\n                    {/* Action Buttons */}\n                    <div className=\"mb-6\">\n                        {activeTab === 'students' && (\n                            <Button\n                                onClick={() => setShowStudentForm(true)}\n                                className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n                            >\n                                <UserPlus className=\"w-4 h-4 mr-2\" />\n                                Créer Identifiants Étudiant\n                            </Button>\n                        )}\n                        \n                        {activeTab === 'parents' && (\n                            <Button\n                                onClick={() => setShowParentForm(true)}\n                                className=\"bg-green-600 hover:bg-green-700 text-white\"\n                            >\n                                <UserPlus className=\"w-4 h-4 mr-2\" />\n                                Créer Identifiants Parent\n                            </Button>\n                        )}\n                        \n                        {activeTab === 'teachers' && (\n                            <Button\n                                onClick={() => {\n                                    setEditingTeacher(null);\n                                    setTeacherForm({ name: '', email: '', phone: '', password: '', groupIds: [] });\n                                    setShowTeacherForm(true);\n                                }}\n                                className=\"bg-purple-600 hover:bg-purple-700 text-white\"\n                            >\n                                <UserPlus className=\"w-4 h-4 mr-2\" />\n                                Créer Identifiants Enseignant\n                            </Button>\n                        )}\n                    </div>\n\n                    {/* Tables */}\n                    {activeTab === 'students' && accounts?.students && (\n                        <Table\n                            data={accounts.students}\n                            columns={studentColumns}\n                            emptyMessage=\"Aucun compte étudiant créé\"\n                        />\n                    )}\n                    \n                    {activeTab === 'parents' && accounts?.parents && (\n                        <Table\n                            data={accounts.parents}\n                            columns={parentColumns}\n                            emptyMessage=\"Aucun compte parent créé\"\n                        />\n                    )}\n                    \n                    {activeTab === 'teachers' && accounts?.teachers && (\n                        <Table\n                            data={accounts.teachers}\n                            columns={teacherColumns}\n                            emptyMessage=\"Aucun compte enseignant créé\"\n                        />\n                    )}\n                </div>\n            </div>\n\n            {/* Student Form Modal */}\n            {showStudentForm && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-md\">\n                        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Créer Identifiants Étudiant</h3>\n                        \n                        <div className=\"mb-4\">\n                            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                                Sélectionner un étudiant SOUTIEN\n                            </label>\n                            <select\n                                value={selectedStudentId}\n                                onChange={(e) => setSelectedStudentId(e.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                            >\n                                <option value=\"\">Choisir un étudiant...</option>\n                                {availableStudents.map((student) => (\n                                    <option key={student.id} value={student.id}>\n                                        {student.name} {student.surname} - {student.schoolLevel}\n                                    </option>\n                                ))}\n                            </select>\n                        </div>\n                        \n                        <div className=\"flex justify-end space-x-3\">\n                            <Button\n                                variant=\"outline\"\n                                onClick={() => {\n                                    setShowStudentForm(false);\n                                    setSelectedStudentId('');\n                                }}\n                            >\n                                Annuler\n                            </Button>\n                            <Button\n                                onClick={createStudentCredentials}\n                                disabled={!selectedStudentId}\n                                className=\"bg-blue-600 hover:bg-blue-700 text-white\"\n                            >\n                                Créer\n                            </Button>\n                        </div>\n                    </div>\n                </div>\n            )}\n\n            {/* Parent Form Modal */}\n            {showParentForm && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-md\">\n                        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Créer Identifiants Parent</h3>\n                        \n                        <div className=\"mb-4\">\n                            <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                                Sélectionner un étudiant SOUTIEN\n                            </label>\n                            <select\n                                value={selectedParentStudentId}\n                                onChange={(e) => setSelectedParentStudentId(e.target.value)}\n                                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                            >\n                                <option value=\"\">Choisir un étudiant...</option>\n                                {availableStudents.map((student) => (\n                                    <option key={student.id} value={student.id}>\n                                        {student.name} {student.surname} - Parent: {student.parentName || 'Non spécifié'}\n                                    </option>\n                                ))}\n                            </select>\n                        </div>\n                        \n                        <div className=\"flex justify-end space-x-3\">\n                            <Button\n                                variant=\"outline\"\n                                onClick={() => {\n                                    setShowParentForm(false);\n                                    setSelectedParentStudentId('');\n                                }}\n                            >\n                                Annuler\n                            </Button>\n                            <Button\n                                onClick={createParentCredentials}\n                                disabled={!selectedParentStudentId}\n                                className=\"bg-green-600 hover:bg-green-700 text-white\"\n                            >\n                                Créer\n                            </Button>\n                        </div>\n                    </div>\n                </div>\n            )}\n\n            {/* Teacher Form Modal */}\n            {showTeacherForm && (\n                <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\n                    <div className=\"bg-white rounded-lg p-6 w-full max-w-lg\">\n                        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">\n                            {editingTeacher ? 'Modifier' : 'Créer'} Identifiants Enseignant\n                        </h3>\n                        \n                        <div className=\"space-y-4\">\n                            <Input\n                                label=\"Nom complet\"\n                                value={teacherForm.name}\n                                onChange={(e) => setTeacherForm({ ...teacherForm, name: e.target.value })}\n                                placeholder=\"Nom de l'enseignant\"\n                            />\n                            \n                            <Input\n                                label=\"Email\"\n                                type=\"email\"\n                                value={teacherForm.email}\n                                onChange={(e) => setTeacherForm({ ...teacherForm, email: e.target.value })}\n                                placeholder=\"email@example.com\"\n                            />\n                            \n                            <Input\n                                label=\"Téléphone\"\n                                value={teacherForm.phone}\n                                onChange={(e) => setTeacherForm({ ...teacherForm, phone: e.target.value })}\n                                placeholder=\"Numéro de téléphone\"\n                            />\n                            \n                            <div className=\"relative\">\n                                <Input\n                                    label=\"Mot de passe\"\n                                    type={showPassword ? 'text' : 'password'}\n                                    value={teacherForm.password}\n                                    onChange={(e) => setTeacherForm({ ...teacherForm, password: e.target.value })}\n                                    placeholder={editingTeacher ? 'Laisser vide pour ne pas changer' : 'Mot de passe'}\n                                />\n                                <button\n                                    type=\"button\"\n                                    onClick={() => setShowPassword(!showPassword)}\n                                    className=\"absolute right-3 top-8 text-gray-400 hover:text-gray-600\"\n                                >\n                                    {showPassword ? <EyeOff className=\"w-4 h-4\" /> : <Eye className=\"w-4 h-4\" />}\n                                </button>\n                            </div>\n                            \n                            <div>\n                                <label className=\"block text-sm font-medium text-gray-700 mb-2\">\n                                    Groupes assignés\n                                </label>\n                                <div className=\"max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2\">\n                                    {availableGroups.map((group) => (\n                                        <label key={group.id} className=\"flex items-center space-x-2 mb-1\">\n                                            <input\n                                                type=\"checkbox\"\n                                                checked={teacherForm.groupIds.includes(group.id)}\n                                                onChange={(e) => {\n                                                    if (e.target.checked) {\n                                                        setTeacherForm({\n                                                            ...teacherForm,\n                                                            groupIds: [...teacherForm.groupIds, group.id]\n                                                        });\n                                                    } else {\n                                                        setTeacherForm({\n                                                            ...teacherForm,\n                                                            groupIds: teacherForm.groupIds.filter(id => id !== group.id)\n                                                        });\n                                                    }\n                                                }}\n                                                className=\"rounded border-gray-300 text-blue-600 focus:ring-blue-500\"\n                                            />\n                                            <span className=\"text-sm text-gray-700\">\n                                                {group.name} - {group.subject}\n                                            </span>\n                                        </label>\n                                    ))}\n                                </div>\n                            </div>\n                        </div>\n                        \n                        <div className=\"flex justify-end space-x-3 mt-6\">\n                            <Button\n                                variant=\"outline\"\n                                onClick={() => {\n                                    setShowTeacherForm(false);\n                                    setEditingTeacher(null);\n                                    setTeacherForm({ name: '', email: '', phone: '', password: '', groupIds: [] });\n                                }}\n                            >\n                                Annuler\n                            </Button>\n                            <Button\n                                onClick={createOrUpdateTeacherCredentials}\n                                disabled={!teacherForm.name || (!editingTeacher && !teacherForm.password)}\n                                className=\"bg-purple-600 hover:bg-purple-700 text-white\"\n                            >\n                                {editingTeacher ? 'Mettre à jour' : 'Créer'}\n                            </Button>\n                        </div>\n                    </div>\n                </div>\n            )}\n        </div>\n    );\n}